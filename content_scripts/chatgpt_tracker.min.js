console.log("Axon AI C: Content script started execution.");let uiCircleContainer,percentageTextElement,hoverMenuElement,fullDetailTextElement,summarizeButton,uiVisibilityInterval,hideMenuTimer,totalTokens=0,CONTEXT_LIMIT=128e3,currentPlatform=null,SELECTORS=null,progressInterval=null,messageObserver=null;function debounce(e,t){let r;return function(...n){const o=this;clearTimeout(r),r=setTimeout((()=>e.apply(o,n)),t)}}const debouncedProcessAllMessages=debounce(processAllMessages,300);function reportContentScriptError(e,t="unknown"){console.error(`Axon AI C: Error in ${t}:`,e),chrome.runtime.sendMessage({action:"reportError",errorDetails:{context:`content_script:${t}`,message:e.message,stack:e.stack}}).catch((e=>console.error("Axon AI C: Failed to send error report to background:",e)))}const MODEL_INFO={ChatGPT:{Default:{limit:128e3}},Gemini:{Default:{limit:1e6}},Claude:{Default:{limit:2e5}}},PLATFORM_SELECTORS={ChatGPT:{mainContainer:"#main",userMessages:'div[data-message-author-role="user"]',assistantMessages:'div[data-message-author-role="assistant"]'},Gemini:{mainContainer:"#chat-history",userMessages:"div.query-content",assistantMessages:"message-content.model-response-text"},Claude:{mainContainer:"div.flex-1.overflow-y-scroll",userMessages:'div[data-testid="user-message"]',assistantMessages:"div.font-claude-message"}};async function init(){try{if(currentPlatform=detectPlatform(),!currentPlatform)return void console.warn("Axon AI C: No supported platform detected. Initialization aborted.");SELECTORS=PLATFORM_SELECTORS[currentPlatform],console.log(`Axon AI C: Initializing for ${currentPlatform}.`),CONTEXT_LIMIT=MODEL_INFO[currentPlatform].Default.limit,injectAnimationStyles(),setupTokenDisplayUI(),startLookoutObserver(),uiVisibilityInterval&&clearInterval(uiVisibilityInterval),uiVisibilityInterval=setInterval(ensureUIVisible,2e3)}catch(e){reportContentScriptError(e,"init"),summarizeButton&&(summarizeButton.disabled=!0,summarizeButton.textContent="Error",summarizeButton.title="An error occurred during initialization. Check console for details."),showNotification("Axon AI: Initialization Error! Check console.",5e3)}}function startLookoutObserver(){try{console.log("Axon AI C: Starting lookout observer to watch for chat container.");new MutationObserver(((e,t)=>{try{const e=document.querySelector(SELECTORS.mainContainer);e?e.dataset.axonWatching||(console.log("Axon AI C: Chat container found. Attaching message observer."),e.dataset.axonWatching="true",attachMessageObserver(e),debouncedProcessAllMessages()):messageObserver&&(console.log("Axon AI C: Chat container removed. Disconnecting old message observer."),messageObserver.disconnect(),messageObserver=null)}catch(e){reportContentScriptError(e,"startLookoutObserver.callback"),t.disconnect(),console.error("Axon AI C: Lookout observer disconnected due to repeated errors.")}})).observe(document.body,{childList:!0,subtree:!0})}catch(e){reportContentScriptError(e,"startLookoutObserver.setup"),console.error("Axon AI C: Failed to set up lookout observer.")}}function attachMessageObserver(e){try{messageObserver&&messageObserver.disconnect(),messageObserver=new MutationObserver((()=>{try{debouncedProcessAllMessages()}catch(e){reportContentScriptError(e,"attachMessageObserver.callback"),messageObserver.disconnect(),messageObserver=null,console.error("Axon AI C: Message observer disconnected due to repeated errors.")}})),messageObserver.observe(e,{childList:!0,subtree:!0})}catch(e){reportContentScriptError(e,"attachMessageObserver.setup"),console.error("Axon AI C: Failed to set up message observer.")}}function injectAnimationStyles(){try{const e="axon-animation-styles";if(document.getElementById(e))return}catch(e){reportContentScriptError(e,"injectAnimationStyles")}}async function countTokens(e){try{if("undefined"!=typeof GPTTokenizer_cl100k_base)try{return GPTTokenizer_cl100k_base.encode(e).length}catch(t){return reportContentScriptError(t,"countTokens.tokenizerEncode"),Math.ceil(e.length/4)}return Math.ceil(e.length/4)}catch(e){return reportContentScriptError(e,"countTokens"),0}}async function processAllMessages(){try{if(!document.querySelector(SELECTORS.mainContainer))return;let e="";const t=document.querySelectorAll(SELECTORS.userMessages),r=document.querySelectorAll(SELECTORS.assistantMessages);t.forEach((t=>{e+=t.innerText+"\n"})),r.forEach((t=>{e+=t.innerText+"\n"})),totalTokens=await countTokens(e),updateTokenDisplayUI()}catch(e){reportContentScriptError(e,"processAllMessages"),totalTokens=0,updateTokenDisplayUI(),percentageTextElement&&(percentageTextElement.textContent="Error")}}function getConversationAsTextForSummary(){try{let e="";const t=document.querySelectorAll(SELECTORS.userMessages),r=document.querySelectorAll(SELECTORS.assistantMessages),n=[];t.forEach((e=>n.push({element:e,type:"user"}))),r.forEach((e=>n.push({element:e,type:"assistant"})));return n.sort(((e,t)=>{const r=e.element.compareDocumentPosition(t.element);return r&Node.DOCUMENT_POSITION_FOLLOWING?-1:r&Node.DOCUMENT_POSITION_PRECEDING?1:0})).forEach((t=>{const r=t.element.cloneNode(!0);r.querySelectorAll('img, button, svg, [aria-label*="copy"], [data-testid*="code-block-header"]').forEach((e=>e.remove()));const n=r.innerText||r.textContent||"",o="user"===t.type?"User":"Assistant";n.trim()&&(e+=`${o}: ${n.trim()}\n\n`)})),e}catch(e){return reportContentScriptError(e,"getConversationAsTextForSummary"),""}}function detectPlatform(){try{const e=window.location.href;return e.startsWith("https://chatgpt.com/")?"ChatGPT":e.startsWith("https://gemini.google.com/")?"Gemini":e.startsWith("https://claude.ai/")?"Claude":null}catch(e){return reportContentScriptError(e,"detectPlatform"),null}}async function sendSummarizeRequest(){if(summarizeButton&&summarizeButton.disabled)return;updateSummarizeButtonState("loading"),uiCircleContainer&&(uiCircleContainer.classList.add("axon-processing"),uiCircleContainer.style.setProperty("--progress-percent","0%"));let e=0;progressInterval=setInterval((()=>{try{e+=5,e<=95&&uiCircleContainer?uiCircleContainer.style.setProperty("--progress-percent",`${e}%`):clearInterval(progressInterval)}catch(e){reportContentScriptError(e,"sendSummarizeRequest.progressInterval"),clearInterval(progressInterval)}}),500);const t=getConversationAsTextForSummary();if(!t)return clearInterval(progressInterval),reportContentScriptError(new Error("No conversation text available for summarization."),"sendSummarizeRequest.noText"),showNotification("No conversation text to summarize.","error"),void updateSummarizeButtonState("idle");try{const e=await chrome.runtime.sendMessage({action:"summarizeConversation",text:t});clearInterval(progressInterval),uiCircleContainer&&uiCircleContainer.style.setProperty("--progress-percent","100%"),e&&e.success?(await navigator.clipboard.writeText(e.summary),showNotification("âœ“ Summary copied to clipboard!","success"),setTimeout((()=>updateSummarizeButtonState("idle")),2e3)):(showNotification(e.error||"Summarization failed. Please try again.","error"),updateSummarizeButtonState("idle"))}catch(e){clearInterval(progressInterval),console.error("Error sending message to service worker or processing response:",e),showNotification("Extension communication error. Try reloading the page.","error"),updateSummarizeButtonState("idle")}}function resetSummarizeButton(e="Summarize"){try{progressInterval&&clearInterval(progressInterval),summarizeButton&&(summarizeButton.textContent=e,summarizeButton.disabled=!1,summarizeButton.style.display="block"),"Summarize"===e&&uiCircleContainer&&(uiCircleContainer.classList.remove("axon-processing"),uiCircleContainer.style.backgroundImage="")}catch(e){reportContentScriptError(e,"resetSummarizeButton")}}function setupTokenDisplayUI(){try{if(document.getElementById("axon-ui-circle-container"))return;const e=document.createElement("div");e.id="axon-notification",document.body.appendChild(e),uiCircleContainer=document.createElement("div"),uiCircleContainer.id="axon-ui-circle-container",percentageTextElement=document.createElement("span"),percentageTextElement.id="axon-percentage-text",uiCircleContainer.appendChild(percentageTextElement),hoverMenuElement=document.createElement("div"),hoverMenuElement.id="axon-hover-menu",hoverMenuElement.style.display="none",fullDetailTextElement=document.createElement("div"),fullDetailTextElement.className="axon-detail-text",hoverMenuElement.appendChild(fullDetailTextElement),summarizeButton=document.createElement("button"),summarizeButton.textContent="Summarize",summarizeButton.addEventListener("click",sendSummarizeRequest),hoverMenuElement.appendChild(summarizeButton),uiCircleContainer.appendChild(hoverMenuElement),document.body.appendChild(uiCircleContainer),uiCircleContainer.addEventListener("mouseenter",(()=>{try{clearTimeout(hideMenuTimer),hoverMenuElement.style.display="flex"}catch(e){reportContentScriptError(e,"uiCircleContainer.mouseenter")}})),uiCircleContainer.addEventListener("mouseleave",(()=>{try{hideMenuTimer=setTimeout((()=>{hoverMenuElement.style.display="none"}),1e3)}catch(e){reportContentScriptError(e,"uiCircleContainer.mouseleave")}})),hoverMenuElement.addEventListener("mouseenter",(()=>{try{clearTimeout(hideMenuTimer)}catch(e){reportContentScriptError(e,"hoverMenuElement.mouseenter")}})),hoverMenuElement.addEventListener("mouseleave",(()=>{try{hideMenuTimer=setTimeout((()=>{hoverMenuElement.style.display="none"}),500)}catch(e){reportContentScriptError(e,"hoverMenuElement.mouseleave")}}))}catch(e){reportContentScriptError(e,"setupTokenDisplayUI"),uiCircleContainer&&(uiCircleContainer.style.display="none"),summarizeButton&&(summarizeButton.disabled=!0)}}function updateTokenDisplayUI(){try{if(!percentageTextElement||!fullDetailTextElement)return;const e=CONTEXT_LIMIT>0?totalTokens/CONTEXT_LIMIT*100:0;percentageTextElement.textContent=`${e.toFixed(0)}%`,fullDetailTextElement.textContent=`Axon (${currentPlatform||"..."}): ${totalTokens} Tokens / ${CONTEXT_LIMIT}`}catch(e){reportContentScriptError(e,"updateTokenDisplayUI"),percentageTextElement&&(percentageTextElement.textContent="N/A"),fullDetailTextElement&&(fullDetailTextElement.textContent="Error")}}function ensureUIVisible(){try{uiCircleContainer&&!uiCircleContainer.isConnected&&document.body.appendChild(uiCircleContainer)}catch(e){reportContentScriptError(e,"ensureUIVisible")}}function onPageLoad(){try{setTimeout(init,500)}catch(e){reportContentScriptError(e,"onPageLoad")}}function showNotification(e,t="info",r=2e3){try{const n=document.getElementById("axon-notification");if(!n)return void console.warn("Axon AI C: Notification element not found.");n.textContent=e,n.classList.remove("success","error","info"),n.classList.add(t),n.classList.add("show"),setTimeout((()=>{try{n.classList.remove("show"),setTimeout((()=>n.classList.remove(t)),300)}catch(e){reportContentScriptError(e,"showNotification.timeout")}}),r)}catch(e){reportContentScriptError(e,"showNotification")}}function updateSummarizeButtonState(e){try{progressInterval&&clearInterval(progressInterval),summarizeButton&&(summarizeButton.disabled="loading"===e,summarizeButton.style.display="loading"===e?"none":"block",summarizeButton.textContent="loading"===e?"Summarizing...":"error"===e?"Error":"Summarize"),uiCircleContainer&&("loading"===e?(uiCircleContainer.classList.add("axon-processing"),uiCircleContainer.style.setProperty("--progress-percent","0%")):"idle"!==e&&"error"!==e||(uiCircleContainer.classList.remove("axon-processing"),uiCircleContainer.style.backgroundImage="",uiCircleContainer.style.setProperty("--progress-percent","0%")))}catch(e){reportContentScriptError(e,"updateSummarizeButtonState")}}window.addEventListener("error",(e=>{reportContentScriptError(e.error||new Error(e.message),`globalWindowError:${e.filename}:${e.lineno}`)}),!0),window.addEventListener("unhandledrejection",(e=>{reportContentScriptError(e.reason||new Error("Unhandled Promise Rejection"),"globalUnhandledRejection")})),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",onPageLoad):onPageLoad();